# 交易（Transaction）

下面以测试网络交易为例子进行说明

## 交易结构
https://www.jianshu.com/p/5b0f42c62d97

## 交易信息序列化内容
0100000001ee3a50b918ca4c232d56f991ef66df2c7683c61743f29b04616dd51ec6b952f7000000006b483045022100d55e97e70a3e562feda4c21e4d50d9148a3c19dc068ed695781b8f742709e938022008d27447261cd0865a4ed22902ed572d63c66a767c361a309ce59b5f3a8b6a8a012103cc6ebd10797b6ef801eb98c901ecfc94b80f9bc0aff920457aadf0f956db82faffffffff02002d3101000000001976a914571870875adf08ce52aab0639b4b1b45f37333a288acea959800000000001976a91483ad7e5a09b46fd0e23202083a542068ccb4fb4488ac00000000

[这里](./data/交易解码.json)可查看完整交易解码结果

交易结构：
![image](./imgs/交易结构.webp)

下面对每个字段进行拆解说明：
- Version, 4 bytes, Little-endian
=> 01000000

- Inputs
=> 483045022100d55e97e70a3e562feda4c21e4d50d9148a3c19dc068ed695781b8f742709e938022008d27447261cd0865a4ed22902ed572d63c66a767c361a309ce59b5f3a8b6a8a012103cc6ebd10797b6ef801eb98c901ecfc94b80f9bc0aff920457aadf0f956db82fa

- Output Counter, 1–9 bytes, VarInt
=> ffffffff02
scriptPubKey的长度为25个字节，以十六进制显示为19个字节。

- Outputs, 
=> 76a91483ad7e5a09b46fd0e23202083a542068ccb4fb4488ac
- 00000000 => Locktime, 4 bytes, Little-endian









## 交易输出
交易输出包含两部分：
- 一定量的比特币，面值为“聪”（satoshis） ，是最小的比特币单位；
- 确定花费输出所需条件的加密难题（cryptographic puzzle）

这个加密难题也被称为锁定脚本(locking script), 见证脚本(witness script), 或脚本公钥 (scriptPubKey)。

交易输出的序列化格式如下表所示：
![image](./imgs/交易输出序列化格式.png)

```json
"vout": [
  {
    "value": 0.2,
    "scriptPubKey": {
      "asm": "OP_DUP OP_HASH160 571870875adf08ce52aab0639b4b1b45f37333a2 OP_EQUALVERIFY OP_CHECKSIG",
      "hex": "76a914571870875adf08ce52aab0639b4b1b45f37333a288ac",
      "reqSigs": 1,
      "type": "pubkeyhash",
      "addresses": [
        "moTUMqKxSXrGeF8ktYcawLLVr6Mg46TQdQ"
      ]
    }
  },
  {
    "value": 0.08450000,
    "scriptPubKey": {
      "asm": "OP_DUP OP_HASH160 83ad7e5a09b46fd0e23202083a542068ccb4fb44 OP_EQUALVERIFY OP_CHECKSIG",
      "hex": "76a91483ad7e5a09b46fd0e23202083a542068ccb4fb4488ac",
      "reqSigs": 1,
      "type": "pubkeyhash",
      "addresses": [
        "msXCejAWLAPZym8JK2516x7gbu3giKWUP3"
      ]
    }
  }
]
```

## 交易输入
输入包含四个元素：
- 一个交易ID，引用包含正在使用的UTXO的交易
- 一个输出索引（vout），用于标识来自该交易的哪个UTXO被引用（第一个为零）
- 一个 scriptSig（解锁脚本），满足放置在UTXO上的条件，解锁它用于支出
- 一个序列号

交易输入的序列化格式如下表所示：
![image](./imgs/交易输入序列化格式.png)

```json
"vin": [
  {
    "txid": "f752b9c61ed56d61049bf24317c683762cdf66ef91f9562d234cca18b9503aee",
    "vout": 0,
    "scriptSig": {
      "asm": "3045022100d55e97e70a3e562feda4c21e4d50d9148a3c19dc068ed695781b8f742709e938022008d27447261cd0865a4ed22902ed572d63c66a767c361a309ce59b5f3a8b6a8a[ALL] 03cc6ebd10797b6ef801eb98c901ecfc94b80f9bc0aff920457aadf0f956db82fa",
      "hex": "483045022100d55e97e70a3e562feda4c21e4d50d9148a3c19dc068ed695781b8f742709e938022008d27447261cd0865a4ed22902ed572d63c66a767c361a309ce59b5f3a8b6a8a012103cc6ebd10797b6ef801eb98c901ecfc94b80f9bc0aff920457aadf0f956db82fa"
    },
    "sequence": 4294967295
  }
]
```

## 比特币交易类型
### P2PKH（Pay-to-Public-Key-Hash）
示例：
```
<Signature> <Public Key> OP_DUP OP_HASH160 <Public Key Hash> OP_EQUALVERIFY OP_CHECKSIG
```

### 多重签名
示例：
```
0 <Signature 1> <Signature 2> ... <Signature M> M <Public Key 1> <Public Key 2> ... <Public Key N> N CHECKMULTISIG
```

### P2SH（Pay-to-Script-Hash）